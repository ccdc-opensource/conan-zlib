steps:
- script: $(conan.python) -m pip install --upgrade conan
  displayName: 'Install conan'

- task: ArtifactoryGenericDownload@3
  inputs:
    connection: 'devops-ccdc-3rd-party'
    specSource: 'taskConfiguration'
    fileSpec: |
      {
        "files": [
          {
            "pattern": "ccdc-conan-metadata/common-3rdparty-config.zip",
            "target": "$(Pipeline.Workspace)/.conan/"
          }
        ]
      }
    failNoOp: true

- task: ArtifactoryConan@1
  inputs:
    conanCommand: 'Config Install'
    configSourceType: 'zip'
    configZipPath: '$(Pipeline.Workspace)/.conan/common-3rdparty-config.zip'
    conanUserHome: '$(Pipeline.Workspace)/.conan'

- task: ArtifactoryConan@1
  inputs:
    conanCommand: 'Add Remote'
    remoteName: 'ccdc-3rdparty-conan-mix'
    artifactoryService: 'devops-ccdc-3rd-party'
    conanRepo: 'ccdc-3rdparty-conan-mix'
    purgeExistingRemotes: true
    conanUserHome: '$(Pipeline.Workspace)/.conan'

- task: ArtifactoryConan@1
  inputs:
    conanCommand: 'Install'
    pathOrReference: '$(conan.package)/$(conan.package_version)@'
    buildName: '$(Build.DefinitionName)'
    buildNumber: '$(Build.BuildNumber)'
    conanUserHome: '$(Pipeline.Workspace)/.conan'
- task: ArtifactoryConan@1
  inputs:
    conanCommand: 'Custom'
    customArguments: 'copy $(conan.package)/$(conan.package_version) $(conan.user)/$(conan.channel)'
    buildName: '$(Build.DefinitionName)'
    buildNumber: '$(Build.BuildNumber)'
    conanUserHome: '$(Pipeline.Workspace)/.conan'

- task: ArtifactoryConan@1
  inputs:
    conanCommand: 'Install'
    pathOrReference: '$(conan.package)/$(conan.package_version)@$(conan.user)/$(conan.channel)'
    extraArguments: '--profile centos7-gcc9-x86_64 --build=zlib'
    buildName: '$(Build.DefinitionName)'
    buildNumber: '$(Build.BuildNumber)'
    conanUserHome: '$(Pipeline.Workspace)/.conan'

- task: ArtifactoryConan@1
  inputs:
    conanCommand: 'Upload'
    patternOrReference: '$(conan.package)/$(conan.package_version)@$(conan.user)/$(conan.channel)'
    extraArguments: '--all'
    buildName: '$(Build.DefinitionName)'
    buildNumber: '$(Build.BuildNumber)'
    conanUserHome: '$(Pipeline.Workspace)/.conan'

